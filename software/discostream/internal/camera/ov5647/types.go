package ov5647

import "github.com/d2r2/go-i2c"

type Ov5647Camera struct {
	I2CAddr uint8
	I2CBus  int
	i2cDev  *i2c.I2C
}

type i2cRequest struct {
	Register uint16
	Value    uint8
}

var (
	OV5647NightMode    = i2cRequest{0x3a00, 0x1c}
	OV5647NightModeOff = i2cRequest{0x3a00, 0x18}
)

var OV5647ResetSequence = []i2cRequest{
	{0x0100, 0x00},
	{0x0103, 0x01},
}

var OV5647InitSequence = []i2cRequest{
	// pll configuration
	{0x3034, 0x1a}, // 10 bit mode, pll charge pump 1 (default value)
	{0x3035, 0x21}, // sysclk divider 2 (12.5 MHz), scale divider 1
	// {0x3036, 0x6c}, // PLL multiplier 108
	{0x3036, 0x78}, // PLL multiplier 120
	{0x3037, 0x03}, // pll prediv 3 (default)
	{0x3018, 0x44}, // one lane mode, power down PHY LP RX
	{0x3016, 0x08}, // mipi pad enable
	{0x303c, 0x11}, // plls cp 1, plls sys div 1 (default)
	// (12.5 MHz * 108) / 3 = 450 Mbps
	// (12.5 MHz * 120) / 3 = 500 Mbps

	// flip and mirror, 2x2 binning
	// {0x3821, 0x03}, // mirror snr, hbin
	// {0x3820, 0x45}, // vflip isp, vbin
	{0x3821, 0x03}, // mirror snr, hbin
	{0x3820, 0x41}, // vflip isp, vbin

	// apparently som, analog settings. Not in datasheet? from linux
	{0x3612, 0x59},
	{0x3618, 0x00},
	// ISP ctrl
	{0x5000, 0x06}, // bc en, wc en, lenc off
	{0x5001, 0x08}, // awb en
	{0x5002, 0x41}, // win en, awb gain en
	{0x5003, 0x08}, // buf en
	{0x5a00, 0x08},
	{0x3000, 0x00},
	{0x3001, 0x00},
	{0x3002, 0x00},
	{0x301d, 0xf0}, // taken from linux

	{0x3a18, 0x00}, // gain ceiling
	{0x3a19, 0xf8},
	{0x3c01, 0x80},
	{0x3b07, 0x0c}, // strobe frex mode?
	// frame timing
	{0x380c, 0x0c},
	{0x380d, 0x8f},
	// {0x380c, 0x07},
	// {0x380d, 0x3c},
	{0x380e, 0x03},
	{0x380f, 0xff},
	// {0x380e, 0x03},
	// {0x380f, 0xf4},
	{0x3814, 0x31},
	{0x3815, 0x31},
	{0x3708, 0x64},
	{0x3709, 0x52},
	// 1280x960
	{0x3808, 0x05},
	{0x3809, 0x00},
	{0x380a, 0x03},
	{0x380b, 0xc0},

	{0x3800, 0x00},
	{0x3801, 0x18}, // start x
	{0x3802, 0x00},
	{0x3803, 0x0e}, // y start

	{0x3804, 0x0a},
	{0x3805, 0x27}, // end x
	{0x3806, 0x07},
	{0x3807, 0x95}, // y end

	{0x3630, 0x2e},
	{0x3632, 0xe2},
	{0x3633, 0x23},
	{0x3634, 0x44},
	{0x3620, 0x64},
	{0x3621, 0xe0},
	{0x3600, 0x37},
	{0x3704, 0xa0},
	{0x3703, 0x5a},
	{0x3715, 0x78},
	{0x3717, 0x01},
	{0x3731, 0x02},
	{0x370b, 0x60},
	{0x3705, 0x1a},
	{0x3f05, 0x02},
	{0x3f06, 0x10},
	{0x3f01, 0x0a},
	{0x3a08, 0x01},
	{0x3a09, 0x2e},
	{0x3a0a, 0x00},
	{0x3a0b, 0xfb},
	{0x3a0d, 0x02},
	{0x3a0e, 0x01},

	{0x3a0f, 0x58},
	{0x3a10, 0x50},
	{0x3a1b, 0x58},
	{0x3a1e, 0x50},
	{0x3a11, 0x60},
	{0x3a1f, 0x28},

	{0x4001, 0x02},
	{0x4004, 0x02},
	{0x4000, 0x09},

	{0x3000, 0x00},
	{0x3001, 0x00},
	{0x3002, 0x00},
	{0x3017, 0xe0},
	{0x301c, 0xfc},
	{0x3636, 0x06},
	{0x3827, 0xec},
	{0x3106, 0xf5},
	{0x301c, 0xf8},
	{0x4800, 0x04},

	{0x3500, 0x00},
	{0x3501, 0x3e},
	{0x3502, 0x00},
	{0x350a, 0x00},
	{0x350b, 0x80},

	{0x3503, 0x00},
	{0x3a00, 0x18},
	// {0x3a00, 0x1c}, // night mode
	{0x3a20, 0x00},
	{0x5101, 0x01},
	{0x5180, 0x40},

	// {0x503d, 0x80}, // test pattern color stripes

	{0x0100, 0x01}, // finally start streaming
}

var OV5647CheckRegs = map[uint16]string{
	0x300A: "0x300a - Chip ID high",
	0x300B: "0x300b - Chip ID low",
	0x0100: "0x0100 - Stream started",
	0x3034: "0x3034 - Bit mode",
	0x3035: "0x3035 - Sys div, scale div",
	0x3036: "0x3036 - PLL multiplier",
	0x3037: "0x3037 - pll prediv",
}
